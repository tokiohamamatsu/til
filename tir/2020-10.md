# 2020-10

## 01

### [Laravel8の新機能！時間テストヘルパー\(タイムトラベル\)を使ってみた！ \- Qiita](https://qiita.com/ucan-lab/items/e983fec6897d85381c20)

時間テストヘルパーは実行時間によって挙動が異なるロジックのテストが行える

使用方法

```php
// 5分進む
$this->travel(5)->minutes();
$this->get($route)->assertSee('Created 5 mins ago');

// 1年先に進む
$this->travel(1)->year();
$this->get($route)->assertSee('Created 1 year ago');

// 指定された日時に移動する
$this->travelTo($user->trial_ends_at);
$this->get($route)->assertSee('Your free trial is expired');

// 未来へタイムトラベル
$this->travel(5)->milliseconds();
$this->travel(5)->seconds();
$this->travel(5)->minutes();
$this->travel(5)->hours();
$this->travel(5)->days();
$this->travel(5)->weeks();
$this->travel(5)->years();

// 過去へタイムトラベル
$this->travel(-5)->hours();

// 正確な時間に移動
$this->travelTo(now()->subHours(6));

// そして時は動き出す...(現在に戻る)
$this->travelBack();
```

CarbonのsetTestNowのラッパーだそう

もう少し早く実装してほしかった

## 02

### [知っておかないと恥ずかしい？！idとclassの違いと記述ルール \- Qiita](https://qiita.com/financier/items/00d193b7f112bf719914)

使用言語 HTML CSS

idとclassの違い

||id|class|
|---|---|---|
|出現回数|文書中に1回だけ|同じ値を使いまわし可能|
|大文字・小文字の区別|する|しない|

```html
    <div id="test">aaaaaa</div> <!--太字にならない-->
    <div id="Test">aaaaaa</div> <!--太字になる-->
```

```css
#Test {
    font-weight: bold;
}
```

上記のコードはidが大文字・小文字を区別するため区別`id="test"`の太さは変わらない。

参照したページにはidとclassのルールとして、先頭は数字にしてはいけないとある。

```HTML
<!-- idは数字から始めることはできません -->
<p id="2020test">これは赤字にならない</p>

<!-- class自体は何から始めてもOKだがCSS自体のルールとして数字がNG -->
<p class="2020service">これも赤字にならない</p>

<!-- これは大丈夫な例 -->
<p class="service2020">これは赤字になる</p>
```

```css
#2020test {
  color: red;
}
.2020service {
  color: red;
}
.service2020 {
  color: red;
}
```

しかし、コメントにはCSSでタイプセレクタを使えば動くとある

```css
*[id="2020test"] {
  color: red;
}
*[class~="2020service"] {
  color: red;
}
.service2020 {
  color: red;
}
```

HTMLの仕様書にもidは数字だけでもいいとある。

[HTML Standard](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)

どちらが正しいのだろうか?

## 05

### [sshトンネルを今さらながらやってみた \- Qiita](https://qiita.com/hfh3oa/items/8c449840d2f2eaebf5dd)

sshトンネルは別名、sshポートフォワーディングと言われる。

ポートフォワーディングは複数の管理をするときに使える技術
主にローカルのポートをリモート先に転送したいときにまたはその逆

[SSHポートフォワーディングを知った話 \- Qiita](https://qiita.com/Ayaka14/items/449e2236af4b8c2beb81)

ローカル(Git Bash)でポートフォワーディングをやった例
使用サーバー　Amazon Linux

```
$ ssh -i id_rsa.pem ec2-user@203.0.113.1
-> ログインできる

$ ssh -L 12345:localhost:80 ec2-user@203.0.113.1 -i id_rsa.pem
```

[Linuxコマンド【 ssh 】リモートマシンにSSHでログイン \- Linux入門 \- Webkaru](https://webkaru.net/linux/ssh-command/)

`-L`はローカルを指す

ローカルでアクセス

```
$ curl http://localhost:12345
-> 203.0.113.1:80 の中身が確認できる。
```
sshポートフォワーディングのメリット

- sshプロトコルを使用することで通信を暗号化
- sshポートがあればローカルで確認できる
- 踏み台サーバを経由してリモートアクセスができる。
```
 ssh -L 12345:localhost:8080 -L 8080:localhost:9080 ec2-user@203.0.113.1
```

[ポートフォワーディングとは \- IT用語辞典 e\-Words](http://e-words.jp/w/%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0.html#:%7E:text=%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF%E3%80%81IP,%E6%8C%81%E3%81%A4%E3%81%9D%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E6%A9%9F%E8%83%BD%E3%80%82)

## 06

### [SQL記述者全員が理解すべきSELECT文の論理的な処理順序のお話 \- Qiita](https://qiita.com/k_0120/items/a27ea1fc3b9bddc77fa1)

SQLの処理順序

```
FROM句
↓
JOIN句
↓
WHERE句
↓
GROUP BY句
↓
HAVING句
↓
SELECT句
↓
ORDER BY句
↓
LIMIT句
```

上記の順序で実行されるため、WHERE句で集約関数(Group BY句)は使う事ができず、またASで別名をつけるのはSELECT句のため、WHERE句で別名をつけることができない。

しかし、これは標準SQLの定義で、実行するRDBMSでクエリは最適化され処理順などが変動する場合がある。

## 07

### [【Vue\.js】Vue\.jsの仕組みについて、知っておくべきこと \- Qiita](https://qiita.com/beanbeenzou/items/c782b2ef379c1513df95)

DOMと仮想DOM

DOMはマークアップ言語をプログラム言語で操作しWebページの見た目を変化する仕組み。

DOMはHTMLドキュメントをオブジェクトのツリー状の集合として扱う。これをDOMツリーと呼ぶ。

Webページを変更するごとにDOMツリーをすべて読みこんでいる。

仮想DOMはDOMツリーの差分を仮想DOMツリーに追加し、Webページに反映する。


Vue.jsは一方向でのJavascriptオブジェクトとDOM要素のやり取りではなく、双方向にし、リアルタイムでデータのやり取りを実現する。Javascriptのライブラリ。

Vue.jsの機能を反映させるにはVueインスタンスが生成された後に、データやDOM要素に接続されている必要がある。

Vue.jsの使い方を別記事を参照

[筋トレしながらわかる💪Vue\.js入門 \- Qiita](https://qiita.com/BooookStore/items/fa457e81a173dfd92df3)

## 08

### [【vue\.js】v\-forでindexを使って少しだけハマった \- Qiita](https://qiita.com/shin_moto/items/85dd2ed2f7341592da73)

```js
<div id="app">
  <ul>
    <div v-for="item in items">
    <input type="text">
    </div>
  </ul>
<button @click="remove">削除</button>
</div>

<script>
export default {
  data() {
    return {
      items: ['えんぴつ','消しゴム','定規'],
    };
  },
methods: {
  remove: function() {
    this.items.shift()
  }
}
})
</script>
```

上記のコードは配列の中身の数だけ、インプットフォームに表示される。また削除ボタンの押下で先頭要素が削除される。

この状態で削除すると配列内の`えんぴつ`の要素が削除されるが、フォームのは最後尾の内容が削除される。

これの対処にkey属性を使おうと言う話

```js
<div id="app">
  <ul>
    <div v-for="item in items" :key="item">
    <input type="text">
    </div>
  </ul>
<button @click="remove">削除</button>
</div>

<script>
export default {
  data() {
    return {
      items: ['えんぴつ','消しゴム','定規'],
    };
  },
methods: {
  remove: function() {
    this.items.shift()
  }
}
})
</script>
```

詳しくは下記を参照

[リストレンダリング — Vue\.js](https://jp.vuejs.org/v2/guide/list.html#%E7%8A%B6%E6%85%8B%E3%81%AE%E7%B6%AD%E6%8C%81)

## 09

### [LaravelのフルURL生成のレア要望に対応する\(しない\)暇人の遊び \- Qiita](https://qiita.com/harmless_3d6/items/3c55ffbc37954b1634b8)

laravelにはURLを作成してくれるヘルパがある

```php
url('') // サイトのURL
url()->current() // アクセスしている現在のページのURL
url()->full() // 現在のページのURLをパラメータまで含める
```

[URL生成 5\.8 Laravel](https://readouble.com/laravel/5.8/ja/urls.html)


このヘルパーはconfigを見ていない

URLのホスト名を変えるにはAppServiceProviderのboot時にconfigを読ませる方法があるが、`url()->full()`の値が変わらない。

```php
  public function boot()
  {
      $this->app['url']->forceRootUrl(config('app.url'));
  }
```

`url()->full()`を変更するには下記の様にする

```php
  public function boot()
  {
      $host = rtrim(preg_replace('/(http(|s):\/\/|\?.*)/', '', config('app.url')), '/');
      $this->app['request']->headers->set('HOST', $host);
  }
```

## 12

### [MySQLがバージョン5から8に飛んだ謎、意外と知らないCharset、Collationのこと \- Qiita](https://qiita.com/yassun-youtube/items/9651710ec602225955af#collation%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)

Charsetは文字コードのことで、MySQLは保存する時、Charsetを指定する。

Charsetのデフォルトは、5.7まではlatin1、8.0からutf8mb4になる。

8.0から絵文字もDBに保存できる。

Charsetの確認方法

Charsetの一覧を表示

```
$ SHOW CHARSET;
```

DB、テーブルのデフォルトのCharsetを調べるコマンド

```
$ SHOW CREATE DATABASE <db名>;

$ SHOW CREATE TABLE <table名>;
```

CollationはDBに保存した文字をソートするときの規則として使われる。

例

```
utf8mb4_ja_0900_as_cs_ks
```

`utf8mb4`は文字コードを示す

`ja`は言語名を示す

`as`はアクセントを区別するか示す
日本語の場合、濁音、半濁音の区別をする。区別しないときはai(accent insensitive)をつける。

`cs`は大文字、小文字を区別するか示す

`ks`はひらがな、カタカナを区別するか示す
言語名を`js`にした場合のみ使える。

```
utf8mb4_ja_0900_as_cs_ks
=> ルールを適用する文字は、文字コード utf8mb4、日本語かつUnicode バージョン9.00であり、濁音・半濁音・大文字・小文字・平仮名・カタカナを区別する。
```

## 13

### [Laravelで画像をリサイズ&勝手に回転しないようにする\(EXIFも削除\) \- Qiita](https://qiita.com/paleo_engineer/items/8d487c6a5683ca1be3da)

laravelで画像を投稿すると、投稿された画像の大きさがおかしかったり、アップロード後に画像が回転してしまうことがあるらしい。

また、画像にはEXIF情報が埋め込まれており、スマートフォンの情報や撮影した場所などが、記録されているのもある。


EXIF情報とリサイズ処理と画像の向きの最適を処理を簡単できるInterventionImageというものがある。

InterventionImageを使うにはConfig/app.phpに以下を記述する。

```php
'providers' => [
    Intervention\Image\ImageServiceProvider::class,
],

//~中略~

'aliases' => [
    'Image' => Intervention\Image\Facades\Image::class,
],
```

driver設定の追加も行う

```php
$php artisan vendor:publish --provider="Intervention\Image\ImageServiceProviderLaravelRecent"
```

InterventionImageを使うにはControllerに以下を記述する

```php
use Intervention\Image\Facades\Image; // Imageファサードを使う
use Illuminate\Support\Facades\Storage; // Storageファサードを使う
```

リサイズの処理

```php
$resized_image = Image::make($posted_image)->fit(640, 360)->encode('jpg');
```

上記は`make`で加工前の画像を取り込み、fitで幅と高さを指定し、トリミングする。

`resize`でも良さそうなのだが、画像が歪んでしまうことがある。

画像が回転する問題とFXIF情報の処理は`orientate()`を使うだけで解決できる

```php
$resized_image->orientate()->save();
```

`save`をしないと処理が反映されない

ファイルを保存するには`store`メソッドが使えす、laravelの`Storage::put`を使う

```php
Storage::put('public/image/' . $image_name, $resized_image); 
```