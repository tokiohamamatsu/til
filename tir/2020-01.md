# 2020-01

## 06

### [動くスプレッド構文 \- Qiita](https://qiita.com/hoo-chan/items/dfe10728d05f83bee41d)

`[...iterableA,...iterableB]`を評価する処理

```js
const iterableA = [A1, A2, A3];
const iterableB = [B1, B2];
const result = [];

const iteratorA = iterableA[Symbol.iterator]();
while (1) {
  const iteratorResult = iteratorA.next();
  if (iteratorResult.done) {
    break;
  }
  result.push(iteratorResult.value);
}

const iteratorB = iterableB[Symbol.iterator]();
while (1) {
  const iteratorResult = iteratorB.next();
  if (iteratorResult.done) {
    break;
  }
  result.push(iteratorResult.value);
}
// result
// {"value":"A1","done":false}
// {"value":"A2","done":false}
// {"value":"A3","done":false}
// {"done":true}
// {"value":"B1","done":false}
// {"value":"B2","done":false}
// {"done":true}
// ["A1","A2","A3","B1","B2"]

```

わからなかったこと

- Symbol.iterator
- .next()
- .done

## 07

### [JavaScript の イテレータ を極める！ \- Qiita](https://qiita.com/kura07/items/cf168a7ea20e8c2554c6)

イテレータとは、順番にイテレータリザルトを取り出すことのできるオブジェクト

イテレータは`.next()`メソッドを持ち、それを実行するとイテレータリザルトを返す

```js
var iterator = {}; // イテレータ
iterator.next = function(){
    var iteratorResult = { value: 42, done: false }; // イテレータリザルト
    return iteratorResult;
};
```

イテレータオブジェクトはオブジェクトであり`.value`と`.done`プロパティを持つ

- `.value`プロパティはイテレータから取り出した値
- `.done`プロパティはイテレータから値を順番に取り出し終えたかどうかの真偽値

イテレータを持つオブジェクトのことをイテラブル(iterable)という

イテラブルは`[Symbol.iterator]()`メソッドを実行するとイテレータを返す

```js
var iterator = {}; // イテレータ
iterator.next = function(){
    var iteratorResult = { value: 42, done: false }; // イテレータリザルト
    return iteratorResult;
};

var obj = {}; // イテラブルなオブジェクト
obj[Symbol.iterator] = function(){
    return iterator;
};
```

例

イテラブルなオブジェクトを作る

1~10の数を順番に取り出せるイテレータを持つイテラブルを作る

```js
var obj = {}; // イテラブルなオブジェクト
obj[Symbol.iterator] = function(){
    var iterator = {}; // イテレータ
    var count = 1;
    iterator.next = function(){
        var iteratorResult = (count <= 10)
            ? { value: count++,   done: false }
            : { value: undefined, done: true };
        return iteratorResult; // イテレータリザルト
    };
    return iterator;
};

var iterator = obj[Symbol.iterator](); // イテラブルなオブジェクトからイテレータを取得する
var iteratorResult;
while(true){
    iteratorResult = iterator.next(); // 順番に値を取りだす
    if(iteratorResult.done) break; // 取り出し終えたなら、break
    console.log(iteratorResult.value); // 値をコンソールに出力
}
```

現在の値が`count`で保持され、`.next()`を実行するごとにカウントアップし、10を超えたら、`.done`をtrueにし値を順番に取り出し終えたことを示す

イテレータから値を取り出す構文に`for(v of iterable)`がある

```js
var obj = {}; // イテラブルなオブジェクト
obj[Symbol.iterator] = function(){
    var iterator = {}; // イテレータ
    var count = 1;
    iterator.next = function(){
        var iteratorResult = (count <= 10)
            ? { value: count++,   done: false }
            : { value: undefined, done: true };
        return iteratorResult; // イテレータリザルト
    };
    return iterator;
};

for(var v of obj) console.log(v);
```

`for(v of iterable)`は以下の処理を順に行う

1. `iterator=iterable[Symbol.iterator]()`を実行し、イテレータを取得する
2. `iteratorResult=iterator.next()`を実行し、イテレータリザルトを取得する
3. `iteratorResult.done==true`なら取り出し終えたので終了、そうでないなら2に戻る

## 08

### [Laravel マイグレーションのロールバックテスト \- Qiita](https://qiita.com/ucan-lab/items/6a5f4acf70c889a0093a)

```php
<?php declare(strict_types=1);

namespace Tests;

class MigrateRollbackTest extends TestCase
{
    public function testRollback()
    {
        $this->artisan('migrate:fresh', ['--seed' => true]);
        $this->artisan('migrate:refresh');

        $this->assertTrue(true);
    }
}
```

`$this->artisan()`メソッドでlaravelのコマンドが実行できる。
ロールバックするには、最新のテーブル定義になっている必要があるので`migrate:fresh`で最新のテーブル構成にした後,`migrate:refresh`でロールバック＆マイグレーションを行う。

phpunit.xmlにテストスイートを追加する

```xml
    <testsuites>
        <testsuite name="Database">
            <file>./tests/MigrateRollbackTest.php</file>
        </testsuite>

        <testsuite name="Unit">
            <directory suffix="Test.php">./tests/Unit</directory>
        </testsuite>

        <testsuite name="Feature">
            <directory suffix="Test.php">./tests/Feature</directory>
        </testsuite>
    </testsuites>
```

`<testsuites>`タグ内にDatabaseテストスイートを追記する

テストの実行は
```
$./vendor/bin/phpunit
```
で実行できる

ロールバックのテストのみ実行したい場合

```
$./vendor/bin/phpunit --testsuite Database
```

オプションでテストしたいテストスイートを指定する

わからないこと

- `<?php declare(strict_types=1);`

## 09

### [phpでapiを切りの良い時刻までキャッシュする \- Qiita](https://qiita.com/inkuringu_ika/items/5737b76c5a2aab536300)

キャッシュされた時刻を取得

```php
$f_timestamp = filemtime('cache_api.json');
$f_time = date('Y/m/d H',$f_timestamp);
```

サーバーの時刻を取得

```php
$s_timestamp=time();
$s_time=date('Y/m/d H',$s_timestamp)
```

取得した時刻を比較する

```php
if($s_time==$f_time){
    $fp=fopen("cache_api.json","r");
    $json = fgets($fp);
    fclose($fp);
}else{
    $opts=array(
        "http"=>array(
            "method"=>"GET",
            "header"=>"User-Agent: php"
        )
    );
    $context=stream_context_create($opts);
    $json=file_get_contents("https://example.com/api/weather.json",false,$context);

    $fp=fopen("cache_api.json","w");
    fwrite($fp,$json);
    fclose($fp);
};
```

時間の比較をし、TrueならキャッシュをロードしFalseならapiを叩く

わからなかったこと

- stream_context_create
- fopen
- fgets
- fclose
- fwite
- User-Agent: php