# 2020-01

## 06

### [動くスプレッド構文 \- Qiita](https://qiita.com/hoo-chan/items/dfe10728d05f83bee41d)

`[...iterableA,...iterableB]`を評価する処理

```js
const iterableA = [A1, A2, A3];
const iterableB = [B1, B2];
const result = [];

const iteratorA = iterableA[Symbol.iterator]();
while (1) {
  const iteratorResult = iteratorA.next();
  if (iteratorResult.done) {
    break;
  }
  result.push(iteratorResult.value);
}

const iteratorB = iterableB[Symbol.iterator]();
while (1) {
  const iteratorResult = iteratorB.next();
  if (iteratorResult.done) {
    break;
  }
  result.push(iteratorResult.value);
}
// result
// {"value":"A1","done":false}
// {"value":"A2","done":false}
// {"value":"A3","done":false}
// {"done":true}
// {"value":"B1","done":false}
// {"value":"B2","done":false}
// {"done":true}
// ["A1","A2","A3","B1","B2"]

```

わからなかったこと

- Symbol.iterator
- .next()
- .done

## 07

### [JavaScript の イテレータ を極める！ \- Qiita](https://qiita.com/kura07/items/cf168a7ea20e8c2554c6)

イテレータとは、順番にイテレータリザルトを取り出すことのできるオブジェクト

イテレータは`.next()`メソッドを持ち、それを実行するとイテレータリザルトを返す

```js
var iterator = {}; // イテレータ
iterator.next = function(){
    var iteratorResult = { value: 42, done: false }; // イテレータリザルト
    return iteratorResult;
};
```

イテレータオブジェクトはオブジェクトであり`.value`と`.done`プロパティを持つ

- `.value`プロパティはイテレータから取り出した値
- `.done`プロパティはイテレータから値を順番に取り出し終えたかどうかの真偽値

イテレータを持つオブジェクトのことをイテラブル(iterable)という

イテラブルは`[Symbol.iterator]()`メソッドを実行するとイテレータを返す

```js
var iterator = {}; // イテレータ
iterator.next = function(){
    var iteratorResult = { value: 42, done: false }; // イテレータリザルト
    return iteratorResult;
};

var obj = {}; // イテラブルなオブジェクト
obj[Symbol.iterator] = function(){
    return iterator;
};
```

例

イテラブルなオブジェクトを作る

1~10の数を順番に取り出せるイテレータを持つイテラブルを作る

```js
var obj = {}; // イテラブルなオブジェクト
obj[Symbol.iterator] = function(){
    var iterator = {}; // イテレータ
    var count = 1;
    iterator.next = function(){
        var iteratorResult = (count <= 10)
            ? { value: count++,   done: false }
            : { value: undefined, done: true };
        return iteratorResult; // イテレータリザルト
    };
    return iterator;
};

var iterator = obj[Symbol.iterator](); // イテラブルなオブジェクトからイテレータを取得する
var iteratorResult;
while(true){
    iteratorResult = iterator.next(); // 順番に値を取りだす
    if(iteratorResult.done) break; // 取り出し終えたなら、break
    console.log(iteratorResult.value); // 値をコンソールに出力
}
```

現在の値が`count`で保持され、`.next()`を実行するごとにカウントアップし、10を超えたら、`.done`をtrueにし値を順番に取り出し終えたことを示す

イテレータから値を取り出す構文に`for(v of iterable)`がある

```js
var obj = {}; // イテラブルなオブジェクト
obj[Symbol.iterator] = function(){
    var iterator = {}; // イテレータ
    var count = 1;
    iterator.next = function(){
        var iteratorResult = (count <= 10)
            ? { value: count++,   done: false }
            : { value: undefined, done: true };
        return iteratorResult; // イテレータリザルト
    };
    return iterator;
};

for(var v of obj) console.log(v);
```

`for(v of iterable)`は以下の処理を順に行う

1. `iterator=iterable[Symbol.iterator]()`を実行し、イテレータを取得する
2. `iteratorResult=iterator.next()`を実行し、イテレータリザルトを取得する
3. `iteratorResult.done==true`なら取り出し終えたので終了、そうでないなら2に戻る

## 08

### [Laravel マイグレーションのロールバックテスト \- Qiita](https://qiita.com/ucan-lab/items/6a5f4acf70c889a0093a)

```php
<?php declare(strict_types=1);

namespace Tests;

class MigrateRollbackTest extends TestCase
{
    public function testRollback()
    {
        $this->artisan('migrate:fresh', ['--seed' => true]);
        $this->artisan('migrate:refresh');

        $this->assertTrue(true);
    }
}
```

`$this->artisan()`メソッドでlaravelのコマンドが実行できる。
ロールバックするには、最新のテーブル定義になっている必要があるので`migrate:fresh`で最新のテーブル構成にした後,`migrate:refresh`でロールバック＆マイグレーションを行う。

phpunit.xmlにテストスイートを追加する

```xml
    <testsuites>
        <testsuite name="Database">
            <file>./tests/MigrateRollbackTest.php</file>
        </testsuite>

        <testsuite name="Unit">
            <directory suffix="Test.php">./tests/Unit</directory>
        </testsuite>

        <testsuite name="Feature">
            <directory suffix="Test.php">./tests/Feature</directory>
        </testsuite>
    </testsuites>
```

`<testsuites>`タグ内にDatabaseテストスイートを追記する

テストの実行は
```
$./vendor/bin/phpunit
```
で実行できる

ロールバックのテストのみ実行したい場合

```
$./vendor/bin/phpunit --testsuite Database
```

オプションでテストしたいテストスイートを指定する

わからないこと

- `<?php declare(strict_types=1);`

## 09

### [phpでapiを切りの良い時刻までキャッシュする \- Qiita](https://qiita.com/inkuringu_ika/items/5737b76c5a2aab536300)

キャッシュされた時刻を取得

```php
$f_timestamp = filemtime('cache_api.json');
$f_time = date('Y/m/d H',$f_timestamp);
```

サーバーの時刻を取得

```php
$s_timestamp=time();
$s_time=date('Y/m/d H',$s_timestamp)
```

取得した時刻を比較する

```php
if($s_time==$f_time){
    $fp=fopen("cache_api.json","r");
    $json = fgets($fp);
    fclose($fp);
}else{
    $opts=array(
        "http"=>array(
            "method"=>"GET",
            "header"=>"User-Agent: php"
        )
    );
    $context=stream_context_create($opts);
    $json=file_get_contents("https://example.com/api/weather.json",false,$context);

    $fp=fopen("cache_api.json","w");
    fwrite($fp,$json);
    fclose($fp);
};
```

時間の比較をし、TrueならキャッシュをロードしFalseならapiを叩く

わからなかったこと

- stream_context_create
- fopen
- fgets
- fclose
- fwite
- User-Agent: php

## 10

### [LaravelのMigrationは書いた順に実行されるわけじゃない \- Qiita](https://qiita.com/kazuhei/items/484ffe1fb8d9cbb056c1)

primary keyのaというカラムを消し。bというカラムをprimary keyにするためにnullableの条件を変えるMigration

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class Sample extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('sample', function (Blueprint $table) {
            $table->dropPrimary();
            $table->unsignedInteger('a')->nullable()->change();
            $table->dropColumn('a');

            $table->unsignedInteger('b')->nullable(false)->change();
            $table->primary(['b']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('sample', function (Blueprint $table) {
            // TODO
        });
    }
}
```

上記の場合以下のSQLが生成される

```php
array:4 [
  0 => "ALTER TABLE sample CHANGE a a INT UNSIGNED DEFAULT NULL, CHANGE b b INT UNSIGNED NOT NULL"
  1 => "alter table `sample` drop primary key"
  2 => "alter table `sample` drop `a`"
  3 => "alter table `sample` add primary key `sample_b_primary`(`b`)"
]
```

この場合 aからprimary keyを外す前にnullを許可しようとするが、primary keyはnullを許可できないため、うまくいかない

migrationが実行される順番はフレームワークの`Illuminate/Database/Schema/Blueprint.php`に書いてある

```php
 /**
     * Add the commands that are implied by the blueprint's state.
     *
     * @param  \Illuminate\Database\Schema\Grammars\Grammar  $grammar
     * @return void
     */
    protected function addImpliedCommands(Grammar $grammar)
    {
        if (count($this->getAddedColumns()) > 0 && ! $this->creating()) {
            array_unshift($this->commands, $this->createCommand('add'));
        }

        if (count($this->getChangedColumns()) > 0 && ! $this->creating()) {
            array_unshift($this->commands, $this->createCommand('change'));
        }

        $this->addFluentIndexes();

        $this->addFluentCommands($grammar);
    }
```

参考した記事によると

1. change
2. add
3. その他(drop,foregin,primaryなど)

の順番で実行されるよう

今回のような場合の対処法としては、Migrationの単位を細かくすること

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class Sample extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('sample', function (Blueprint $table) {
            $table->dropPrimary();
        });
        Schema::table('sample', function (Blueprint $table) {
            $table->unsignedInteger('a')->nullable()->change();
            $table->dropColumn('a');
        });
        Schema::table('sample', function (Blueprint $table) {
            $table->unsignedInteger('b')->nullable(false)->change();
            $table->primary(['b']);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('sample', function (Blueprint $table) {
            // TODO
        });
    }
}
```

わからなかったこと

- Migrationで生成されるSQLの見方
- SQL文
  - alter table とか 

## 14

### [Goutteで空港情報を取得してみる \- Qiita](https://qiita.com/taka0610/items/ed0f761d20dc74cca5e7)

空港の情報をスクレイピングする

スクレイピングとは

>スクレイピングはサーバサイドのプログラミング言語を使って外部サーバへアクセスし、そのコンテンツから自分たちの欲しい情報を引き出す手法です。多くはHTMLを返す場合に使われ、DOMを解析したり正規表現を使ってデータを抜き出します。 引用\(スクレイピングとAPIの違い\)
>[Goutteで空港情報を取得してみる - Qiita](https://qiita.com/taka0610/items/ed0f761d20dc74cca5e7)

https://www.airlineguide.jp/airport-codes/
をスクレイピングする

※スクレイピングするのは自己責任

サイト内のテーブルの１列目の空港コードと3列目(なければ4列目)の空港名を取得する

```php
namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Goutte;
use Illuminate\Support\Facades\DB;

class AirPortController extends Controller
{
    //
    public function index(){
        $url = 'https://www.airlineguide.jp/airport-codes/';

        $airCode = array();
        $count = 0;

        $crawler = Goutte::request('GET', $url);
        $crawler->filter('table tr')->each(function($node) use(&$airCode,&$count) {

            if(count($node->filter('td'))){
                //空港コード
                $airCode[$count]['code'] = $node->filter('td')->eq(0)->text();
                //空港名
                if($node->filter('td')->eq(2)->text() === ''){
                    $airCode[$count]['airPort'] = $node->filter('td')->eq(3)->text();
                }else{
                    $airCode[$count]['airPort'] = $node->filter('td')->eq(2)->text();
                }
                $count++;
            }

        });

        //DBに空港情報登録
        foreach ($airCode as  $value){
            DB::table('airports')->insert(['airport_code' => $value['code'],
                'airport_name'=> $value['airPort']]);
        }

    }
}
```

わからなかったこと

- Goutte

## 15

### [Goutte使ってスクレイピングしたのでまとめてみる \- Qiita](https://qiita.com/fksk/items/6807d5de07f93114087c)

Goutteとは

>端的にいうと，Goutte\(グット\)は，PHP製のWebスクレイピングのライブラリで，スクレイピング目的だけではなく，ブラウザを操作することでテストにも使われるみたいです． また，主要機能もSymfonyのコンポーネントで構成されており，生みの親はSymfonyプロジェクトリーダーのFabien Potencier氏です．
>[Goutte使ってスクレイピングしたのでまとめてみる - Qiita](https://qiita.com/fksk/items/6807d5de07f93114087c)

使い方としては前回の記事と同じようにrequest()でHTTPリクエストし、html()でHTMLを取得する。

※html()ではなくtext()を使うとhtmlタグが抜けたテキストがとれるらしい

```php
require 'vendor/autoload.php';
use Goutte\Client;

$client = new Client();
$url = 'https://ja.wikipedia.org/';
$crawler = $client->request('GET',$url);
$html = $crawler->html();

print_r($html);
```

取得する箇所を絞込するにはfilter()にCSSのようにタグを指定する、tableの場合は、each()とクロージャでfilter()を使いth,tdなどから情報を取得できる。

※クロージャの中でfilterする前に、th,tdに値があるか確認しないとエラーになる

```php
require 'vendor/autoload.php';
use Goutte\Client;

$client = new Client();
$url = 'https://ja.wikipedia.org/wiki/岩手県立大学';
$crawler = $client->request('GET',$url);
$crawler->filter('table.infobox tr')->each(function($element){
    if(count($element->filter('th')) && count($element->filter('td'))){
        $th = $element->filter('th')->text();
        $td = $element->filter('td')->text();
        echo $th."：".$td."\n";
    }
```

フォームに値を入れてサブミットした結果も取得でき、selectButton()で、送信ボタンの値を取得し、入力するフィールドのnameと入力する値の組み合わせの配列を作り、submit()でこれらを使えば、サブミットした結果を取得できる。

わからなかったこと

- クロージャ

## 16

### [JavaScriptで空白や改行のみの場合も空文字判定する方法 \- Qiita](https://qiita.com/To-ka/items/ebb818a1c2075332d5be)

textareaやinputで空文字判定したい場合

```html
 <textarea id="text"></textarea>
    <script>
        var text = document.getElementById('text')
    </script>
```

```js
text.value === ''
!text.value
```

などで空文字判別ができるが、空白や改行があった場合には空文字ではなくなる。

`match()`を使えばこれを解決できる

```js
!text.value.match(/\S/g))
```

※`\S`は正規表現で空白文字以外全ての事

!text.valueと組み合せることで、空白や改行があったとしても空文字の判定ができる

わからなかったこと

- 正規表現

## 17

### [初心者歓迎！手と目で覚える正規表現入門・その１「さまざまな形式の電話番号を検索しよう」 \- Qiita](https://qiita.com/jnchito/items/893c887fbf19e17d3ff9)

電話番号の正規表現

半角英数字が2～5個、ハイフン、半角英数字が1～4個、ハイフン、半角英数字が4個の場合

`\d{2,5}-\d{1,4}-\{4}`

`\d`は一個の半角数字の意味を持ち、`/d/d`の場合二個の半角数字の意味になる。

文字数を指定する場合は`{n,m}`や`{n}`を使う。

- `{n,m}`は直前の文字がn個以上、m個以下の意味
- `{n}`はn個の意味

ハイフンだけでなく括弧にも対応する場合

半角英数字が2～5個、ハイフンまたは括弧(開き)、半角英数字が1～4個、ハイフンまたは括弧(閉じ)、半角英数字が4個の場合

`\d{2,5}[-(]\d{1,4}[-)]\{4}`

AまたはBのいずれかの1文字を表す場合は`[AB]`となり、`[ABC]`の場合はAまたはBまたはCのいずれかの意味になる。

そのため、ハイフンまたは括弧(開き)、ハイフンまたは括弧(閉じ)の場合はそれぞれ、`[-(]`,`[-)]`となる

※[ ]の中のハイフンは特別な意味をもち、`[a-z]`と書くとaからzのどれかの意味となる。`[a-zA-Z0-9]`とすると半角英数字のどれかの意味となる。
[ ]の中でハイフンを文字として扱う場合は先頭に置く。

## 20

### [初心者歓迎！手と目で覚える正規表現入門・その２「微妙な違いを許容しつつ置換しよう」 \- Qiita](https://qiita.com/jnchito/items/64c3fdc53766ac6f2008)


様々な区切り文字を許容する

画面上わかりにくいが、`[ 　・]`の中身は半角スペースと全角スペース、中黒の三文字が含まれている。

区切り文字がない場合も許容するため`?`を使う。

`?`は、～が1文字、または無しを表現する。

`?`を使うと正規表現は`[ 　・]?`となる

正規表現の`[ 　・]`部分は厳密に文字種を指定しなくても、任意の1文字で十分な場合がある、

正規表現には、任意の1文字を表す`.`というメタ文字あり、正規表現を書き直すと`.?`となる。

正規表現で置換処理をする

以下のHTMLをCSVに変換する

```html
<select name="game_console">
<option value="wii_u">Wii U</option>
<option value="ps4">プレステ4</option>
<option value="gb">ゲームボーイ</option>
</select>
```

selectの中身をCSVに変化する

ほしい結果

```
wii_u,Wii U
ps4,プレステ4
gb,ゲームボーイ
```

valueを抜き出す

optionのvalueのパターンは、value=、ダブルクォート、英文字またはアンダースコアが1文字以上、ダブルクォートで、これを正規表現で表すと、

`value="[a-z0-9_]+"`となる。

`+`は直前の文字を1文字以上を表す。

表示テキストを抜き出す

`>`で始まり、何かしらの文字が続き、`<`で終わる、を正規表現で表すと。

`>.+<`となる

※ 厳密いうと`>`、`<`はタグの一部で表示テキストではない。

今回の場合をcsv形式に置換するには

1. 行全体にマッチする正規表現を作る
2. valueと表示テキストの部分をそれぞれ ( ) で囲んでキャプチャする
3. キャプチャを利用して新しい文字列を組み立てる

行全体のマッチする正規表現を作る

`<option value="[a-z0-9_]+">.+<\/option>`

`<\/option>`の`\`は`/`エスケープするためのエスケープ文字でRubyやjavascriptで`/`を使い正規表現オブジェクトを作るので、`/`をエスケープする必要がある。

valueと表示テキストの部分をそれぞれ ( ) で囲んでキャプチャする

valueと表示テキストを()で囲み正規表現で

`<option value="([a-z0-9_]+)">(.+)<\/option>`

とする。

これを使うと以下のようになる。

```
Match 1
1.  wii_u
2.  Wii U
Match 2
1.  ps4
2.  プレステ4
Match 3
1.  gb
2.  ゲームボーイ
```

1がvalueで、2が表示テキストになる。
正規表現で()を使うと、その部分が補足され、連番が付けられる。

キャプチャを利用して新しい文字列を組み立てる

置換ができるテキストエディタを使う(今回はAtom)

AtomのReplace in current bufferに`$1`,`$2`を入力し、Replaseを実行すると、最初のoptionが`wii_u,Wii U`に置換される。

`$1`と`$2`はそれぞれ、補足された1番目の文字と2番目の文字列を表す。