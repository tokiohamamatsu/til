# 排他制御の考え方

## 楽観ロック(楽観的排他制御)

データそのものにロックは行わず、更新対象のデータが取得時と同じ状態であることを確認してから更新する方法。

ロックキーと呼ばれる更新対象のデータが取得時のデータと同じ状態であることを判断するためのカラムを使う。

例

更新対象のデータと取得時のデータが同じ状態なのを確認するために、Versionカラムを作成し、更新時に、Versionの値を変化させる。

こうすることで、取得時のデータと更新後のデータが違う状態になるため、更新することができなくなる。

## 悲観ロック(悲観的排他制御)

更新対処のデータを取得する際にロックし、他のトランザクションから更新できないようにする方法。

トランザクション開始直後に更新対象のレコードのロックを取得する。ロックされたレコードはトランザクションが、コミットまたはロールバックされるまで、他のトランザクションから更新できない。

データのロック`SELECT~FOR UPDATE`を利用して実現されるのが、一般的だそう。
[SQL select for updateのサンプル \| ITSakura](https://itsakura.com/sql-select-forupdate)

悲観ロックだと解放漏れはもちろん、処理中にPCが強制的シャットダウンされるなどが起きるとロックされたままの状態になり、操作不可になる。

対応策としては、管理者でロックを解放できる機能を設ける、長時間ロックされているデータのロックを解放する機能を設けるなどが、挙げられる。

こちらの方法もある。　[FOR UPDATE の排他ロックを解除できなくなった場合の対処法 \- Oracle \- Project Group](https://www.projectgroup.info/tips/Oracle/Oracle_000033.html)

## 比較

||楽観ロック|悲観ロック|
|---|---|---|
|前提|開始から終了までに他者からの更新はめったに起きない|開始から終了までに他者からの更新が頻繁に起こる|
|競合検知のタイミング|終了時に検知|開始時に検知|
|開発コスト|低い|高い|

### 参考

[排他制御（楽観ロック・悲観ロック）の基礎　 \- Qiita](https://qiita.com/NagaokaKenichi/items/73040df85b7bd4e9ecfc)